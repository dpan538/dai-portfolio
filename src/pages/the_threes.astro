---
import BaseLayout from "../layouts/base_layout.astro";

const total = 22;

// Flow 图片：threes_01.png ~ threes_22.png
const spreads = Array.from({ length: total }, (_, i) => {
    const num = String(i + 1).padStart(2, "0");
    return `/projects/the_threes/threes_${num}.png`;
});

// 封面 / 收尾
const coverImg = `/projects/the_threes/threes_23.jpg`;
const endImg = `/projects/the_threes/threes_24.jpg`;

const pageTitle = "The Threes";
const pageDescription =
    "The Threes — a quiet book-object of poetry, image, and story, sequenced as a single continuous experience.";
---

<BaseLayout title={pageTitle} description={pageDescription} canonical="https://daipan.art/the_threes" ogImage={coverImg} ogType="article" active="the_threes" breadcrumbs={[{ name: "Home", url: "https://daipan.art" }, { name: "The Threes", url: "https://daipan.art/the_threes" }]}>

    <!-- 1) HERO FIRST（单列，首屏即 hero 图） -->
    <section class="threes threes__intro" id="top">
        <figure
            class="threes__hero"
            aria-label="The Threes cover"
            data-scroll-to="#flow">
            <img
                src={coverImg}
                alt="The Threes cover"
                loading="eager"
            />
        </figure>
        <p class="threes__lead">
            Poetry, image, and story collected into a single, hand-built book-object — meant to be moved
            through slowly, more like weather than a statement.
        </p>
        <span class="threes__hint">Click to begin · Scroll to drift through the spreads</span>
    </section>

    <!-- 2) TEXT DESCRIPTION -->
    <section class="threes threes__text" id="description">
        <div class="threes__text-wrap">
            <p>
                The Threes is a curated collection of literary and visual works, presented in three interconnected
                sections: Poetry, Image, and Story. This selection brings together a range of creative explorations,
                showcasing fluid narratives and thoughtful imagery crafted throughout 2025. Designed as an experience
                rather than a statement, each section offers its own perspective, inviting viewers to explore multiple
                ways of seeing and feeling the subtle connections between words, visuals, and personal reflection.
            </p>

            <p>
                The collection features 18 poems and a short narrative story, each piece drawing inspiration from
                personal introspection, philosophical inquiry, and fragmented memories. Rooted in reflections on
                identity, emotional resonance, and subtle encounters in everyday life, these works capture fleeting
                moments of clarity within an ever-changing reality.
            </p>

            <p>
                This project is ultimately an exercise in creative purification — a personal, artistic baptism realized
                through literature, abstract illustration, and meticulous book design. By writing, designing, and
                assembling the collection independently, I sought to engage deeply with each aspect of the process,
                exploring the boundaries between poetic expression, visual abstraction, and crafted narrative.
            </p>
        </div>
    </section>

    <!-- 3) MAIN COVER FLOW -->
    <section class="threes threes__flow" id="flow">
        <header class="threes__flow-header">
            <h2 class="threes__flow-title">BROWSE THE SPREADS</h2>
            <p class="threes__flow-sub">
                Drag, scroll, or use the arrow keys. Press <kbd>Enter</kbd> to focus · <kbd>Esc</kbd> to close.
            </p>
        </header>

        <div class="threes__flow-stage" data-flow-stage>
            {spreads.map((src, i) => (
                <button
                    class="threes__card"
                    type="button"
                    data-index={i}
                    aria-label={`Open spread ${i + 1}`}>
                    <img
                        src={src}
                        alt={`The Threes spread ${i + 1}`}
                        loading={i < 3 ? "eager" : "lazy"}
                    />
                </button>
            ))}
        </div>
        <button type="button" class="threes__flow-back" data-flow-back aria-label="Back to first spread">
            BACK
        </button>
    </section>

    <!-- Lightbox（与 masks.astro 一致：点击背景关闭、ESC、左右键切换） -->
    <div id="lightbox" class="lightbox hidden">
        <button class="prev" type="button">←</button>
        <img id="lightbox-image" alt="Spread" />
        <button class="next" type="button">→</button>
    </div>

    <!-- 4) OUTRO / ENDING -->
    <section class="threes threes__outro" id="end">
        <figure class="threes__outro-media" aria-label="The Threes ending mockup">
            <img
                src={endImg}
                alt="The Threes ending mockup"
                loading="lazy"
            />
        </figure>

        <div class="threes__outro-text">
            <p class="threes__outro-line">
                what was seen, what was said, what remained.
            </p>
        </div>
    </section>

    <style>
        /* 主界面不横向滚动（整体不出现横向滚动条） */
        :global(html),
        :global(body) {
            overflow-x: hidden;
        }

        /* 侧栏固定在视口左侧：向下滚动时只有主内容在动，侧栏始终贴在屏幕左边 */
        :global(.shell .sidebar) {
            position: fixed;
            left: 0;
            top: 0;
            width: 320px;
            height: 100vh;
            z-index: 20;
        }
        /* 主内容显式放在第二列，避免被 fixed 的侧栏挤出布局 */
        :global(.shell .content) {
            grid-column: 2;
        }

        .threes {
            width: 100%;
        }

        .threes + .threes {
            margin-top: 56px;
        }

        /* ==== INTRO / HERO（首屏即 hero 图，单列，无圆角） ==== */
        .threes__intro {
            padding-top: 8px;
        }

        .threes__hero {
            margin: 0 0 24px;
            overflow: hidden;
            border: 1px solid var(--line);
            background: #f8f8f8;
            cursor: pointer;
            transition: transform 220ms ease, box-shadow 220ms ease;
        }

        .threes__hero img {
            display: block;
            width: 100%;
            height: auto;
        }

        .threes__hero:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
        }

        .threes__lead {
            margin: 0 0 12px;
            max-width: 70ch;
            color: var(--muted);
            line-height: 1.65;
            font-size: 0.95rem;
        }

        .threes__hint {
            display: block;
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 8px;
        }

        /* ==== TEXT BLOCK ==== */
        .threes__text-wrap {
            max-width: 70ch;
            line-height: 1.78;
            font-size: 0.95rem;
            color: rgba(0, 0, 0, 0.78);
        }

        .threes__text-wrap p {
            margin: 0 0 18px;
        }

        .threes__text-wrap p:last-child {
            margin-bottom: 0;
        }

        /* ==== FLOW SECTION（标题与 intro 同宽，flow 舞台占满横向） ==== */
        .threes__flow-header {
            max-width: var(--max);
            margin-inline: auto;
            margin-bottom: 18px;
        }

        .threes__flow-title {
            margin: 0 0 6px;
            font-size: 1rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .threes__flow-sub {
            margin: 0;
            font-size: 0.8rem;
            color: var(--muted);
        }

        kbd {
            font: inherit;
            font-size: 0.75rem;
            padding: 1px 6px;
            border: 1px solid var(--line);
            background: #f8f8f8;
        }

        /* flow 占满主内容区横向宽度；舞台本身负责背景和边框 */
        .threes__flow {
            position: relative;
            width: 100%;
        }

        .threes__flow-stage {
            position: relative;
            height: 520px;
            margin-top: 12px;
            border: 1px solid var(--line);
            background: #fafafa;
            overflow: visible;
            perspective: 1400px;
        }

        .threes__card {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-style: preserve-3d;
            border: none;
            padding: 0;
            background: transparent;
            cursor: pointer;
            will-change: transform, opacity;
        }

        .threes__card img {
            width: min(520px, 72vw);
            height: auto;
            display: block;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.24);
            user-select: none;
            -webkit-user-drag: none;
        }

        .threes__card[aria-current="true"] img {
            box-shadow: 0 26px 70px rgba(0, 0, 0, 0.35);
        }

        .threes__card--hidden {
            display: none;
        }

        /* 滑到最右时显示 BACK（圆角框） */
        .threes__flow-back {
            position: absolute;
            right: 24px;
            bottom: 24px;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            z-index: 30;
            margin: 0;
            padding: 10px 16px;
            font-size: 0.85rem;
            letter-spacing: 0.06em;
            color: var(--muted);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--line);
            border-radius: 999px;
            cursor: pointer;
        }
        .threes__flow.threes__flow--at-end .threes__flow-back {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        .threes__flow-back:hover {
            color: var(--text);
            background: #fff;
        }

        /* ==== LIGHTBOX（全视口固定，不受 content 的 max-width 和页面滚动影响） ==== */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            max-width: none !important;
            height: 100vh;
            background: rgba(0, 0, 0, 0.92);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .lightbox img {
            max-height: 90vh;
            max-width: 90vw;
            display: block;
        }

        .lightbox.hidden {
            display: none;
        }

        .lightbox button {
            position: absolute;
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
        }

        .lightbox .prev {
            left: 30px;
        }
        .lightbox .next {
            right: 30px;
        }

        /* ==== OUTRO ==== */
        .threes__outro {
            margin-top: 64px;
            padding-bottom: 12px;
        }

        .threes__outro-media {
            margin: 0;
            overflow: hidden;
            border: 1px solid var(--line);
            background: #f7f7f7;
        }

        .threes__outro-media img {
            width: 100%;
            height: auto;
            display: block;
        }

        .threes__outro-text {
            margin-top: 18px;
            display: flex;
            justify-content: center;
        }

        .threes__outro-line {
            font-size: 0.9rem;
            color: var(--muted);
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }

        @media (max-width: 860px) {
            .threes + .threes {
                margin-top: 40px;
            }

            .threes__flow-stage {
                height: 440px;
            }
        }
    </style>

    <script type="module">
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
        const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
        const prefersReducedMotion = window.matchMedia?.(
            "(prefers-reduced-motion: reduce)",
        )?.matches;

        const FLOW_CONFIG = {
            spacing: 230,
            rotationStep: 16,
            scaleDecay: 0.12,
            visibleRange: 5,
            depthStep: 110,
        };

        // --- smooth scroll from CTA / cover ---
        $$("[data-scroll-to]").forEach((el) => {
            el.addEventListener("click", () => {
                const targetSel = el.getAttribute("data-scroll-to");
                const target = targetSel
                    ? document.querySelector(targetSel)
                    : null;
                if (!target) return;
                target.scrollIntoView({
                    behavior: prefersReducedMotion ? "auto" : "smooth",
                    block: "start",
                });
            });
        });

        // --- cover flow ---
        const stage = document.querySelector("[data-flow-stage]");
        if (!stage) {
            console.warn("[the_threes] missing flow stage");
        } else {
            const cards = $$("[data-index]", stage);
            if (!cards.length) {
                console.warn("[the_threes] no cards found");
            } else {
                let position = 0; // 可以是小数，表示“当前中心索引”
                let velocity = 0;
                let animating = false;

                const maxIndex = cards.length - 1;

                function applyLayout() {
                    cards.forEach((card, i) => {
                        const offset = i - position;
                        const abs = Math.abs(offset);

                        if (abs > FLOW_CONFIG.visibleRange) {
                            card.classList.add("threes__card--hidden");
                            return;
                        }

                        card.classList.remove("threes__card--hidden");

                        const x = offset * FLOW_CONFIG.spacing;
                        const z = -abs * FLOW_CONFIG.depthStep;
                        const rot = clamp(
                            offset * -FLOW_CONFIG.rotationStep,
                            -55,
                            55,
                        );
                        const scale = Math.max(
                            0.6,
                            1 - abs * FLOW_CONFIG.scaleDecay,
                        );
                        const opacity = 1 - abs * 0.15;

                        card.style.transform =
                            `translate(calc(-50% + ${x}px), -50%) rotateY(${rot}deg) translateZ(${z}px) scale(${scale})`;
                        card.style.opacity = String(opacity);
                        card.style.zIndex = String(1000 - Math.round(abs * 10));
                        card.setAttribute(
                            "aria-current",
                            Math.round(position) === i ? "true" : "false",
                        );
                    });

                    const flowSection = stage.closest(".threes__flow");
                    if (flowSection) {
                        const atEnd = position >= maxIndex - 0.3;
                        flowSection.classList.toggle("threes__flow--at-end", atEnd);
                    }
                }

                function ensureAnimating() {
                    if (animating) return;
                    animating = true;
                    const step = () => {
                        if (!animating) return;

                        const target = clamp(
                            Math.round(position),
                            0,
                            maxIndex,
                        );
                        const snap = target - position;

                        position += velocity;
                        velocity *= 0.9; // 惯性衰减
                        position += snap * 0.08; // 轻微弹性收束到最近索引

                        if (
                            Math.abs(velocity) < 0.001 &&
                            Math.abs(snap) < 0.001
                        ) {
                            position = target;
                            velocity = 0;
                            animating = false;
                            applyLayout();
                            return;
                        }

                        applyLayout();
                        requestAnimationFrame(step);
                    };
                    requestAnimationFrame(step);
                }

                // 初始布局
                applyLayout();

                // --- pointer drag with inertia ---
                let dragging = false;
                let lastX = 0;
                let lastTime = 0;
                let dragMoved = 0;

                stage.addEventListener("pointerdown", (e) => {
                    dragging = true;
                    dragMoved = 0;
                    lastX = e.clientX;
                    lastTime = performance.now();
                    stage.setPointerCapture?.(e.pointerId);
                    velocity = 0;
                });

                stage.addEventListener("pointermove", (e) => {
                    if (!dragging) return;
                    const now = performance.now();
                    const dx = e.clientX - lastX;
                    const dt = now - lastTime || 16;

                    dragMoved += Math.abs(dx);

                    // 根据拖动距离更新 position（向右拖 = 看前一页）
                    position -= dx / FLOW_CONFIG.spacing;
                    position = clamp(position, 0, maxIndex);

                    // 记录速度（索引/帧）
                    const vPxPerMs = dx / dt;
                    velocity = -vPxPerMs * 16 * (1 / FLOW_CONFIG.spacing);

                    lastX = e.clientX;
                    lastTime = now;

                    applyLayout();
                });

                function endDrag(e) {
                    if (!dragging) return;
                    dragging = false;
                    if (e.pointerId != null) {
                        stage.releasePointerCapture?.(e.pointerId);
                    }

                    // 轻点不进入惯性，而是视为 click（交给 card 自己的 click 事件）
                    if (dragMoved < 4) {
                        velocity = 0;
                        return;
                    }

                    ensureAnimating();
                }

                stage.addEventListener("pointerup", endDrag);
                stage.addEventListener("pointercancel", endDrag);

                // --- 滑到最右时点击「返回第一页」平滑回到第一页 ---
                const backBtn = document.querySelector("[data-flow-back]");
                if (backBtn) {
                    backBtn.addEventListener("click", () => {
                        velocity = -1.2;
                        ensureAnimating();
                    });
                }

                // --- wheel / trackpad ---
                stage.addEventListener(
                    "wheel",
                    (e) => {
                        const mag =
                            Math.abs(e.deltaX) > Math.abs(e.deltaY)
                                ? e.deltaX
                                : e.deltaY;
                        if (Math.abs(mag) < 4) return;

                        // 使用小步长，让体验更像缓慢推动
                        position = clamp(
                            position + (mag > 0 ? 0.3 : -0.3),
                            0,
                            maxIndex,
                        );
                        velocity += (mag > 0 ? 0.02 : -0.02);
                        ensureAnimating();
                    },
                    { passive: true },
                );

                // --- Lightbox（与 masks.astro 一致：点击背景关闭、ESC、左右键切换） ---
                const lightbox = document.getElementById("lightbox");
                const lightboxImage = document.getElementById("lightbox-image");
                const sources = cards.map(
                    (el) => el.querySelector("img")?.currentSrc || el.querySelector("img")?.src || "",
                );
                let current = 0;
                const originalOverflow = document.documentElement.style.overflow;

                function openLightbox(i) {
                    if (!lightbox || !lightboxImage) return;
                    current = clamp(i, 0, maxIndex);
                    lightboxImage.src = sources[current];
                    lightbox.classList.remove("hidden");
                    document.documentElement.style.overflow = "hidden";
                }

                function closeLightbox() {
                    if (!lightbox) return;
                    lightbox.classList.add("hidden");
                    document.documentElement.style.overflow = originalOverflow || "";
                }

                cards.forEach((card) => {
                    card.addEventListener("click", () => {
                        if (dragging || dragMoved > 6) return;
                        const raw = card.getAttribute("data-index");
                        const idx = raw ? Number(raw) : NaN;
                        if (!Number.isFinite(idx)) return;
                        openLightbox(idx);
                    });
                });

                lightbox?.querySelector(".prev")?.addEventListener("click", (e) => {
                    e.stopPropagation();
                    current = (current - 1 + sources.length) % sources.length;
                    lightboxImage.src = sources[current];
                });
                lightbox?.querySelector(".next")?.addEventListener("click", (e) => {
                    e.stopPropagation();
                    current = (current + 1) % sources.length;
                    lightboxImage.src = sources[current];
                });

                lightbox?.addEventListener("click", (e) => {
                    if (e.target === lightbox) closeLightbox();
                });

                window.addEventListener("keydown", (e) => {
                    const isOpen = lightbox && !lightbox.classList.contains("hidden");

                    if (isOpen) {
                        if (e.key === "Escape") closeLightbox();
                        if (e.key === "ArrowLeft") {
                            e.preventDefault();
                            current = (current - 1 + sources.length) % sources.length;
                            lightboxImage.src = sources[current];
                        }
                        if (e.key === "ArrowRight") {
                            e.preventDefault();
                            current = (current + 1) % sources.length;
                            lightboxImage.src = sources[current];
                        }
                        return;
                    }

                    if (e.key === "ArrowLeft") {
                        position = clamp(position - 1, 0, maxIndex);
                        ensureAnimating();
                    }
                    if (e.key === "ArrowRight") {
                        position = clamp(position + 1, 0, maxIndex);
                        ensureAnimating();
                    }
                    if (e.key === "Enter") {
                        openLightbox(Math.round(position));
                    }
                });
            }
        }
    </script>
</BaseLayout>

